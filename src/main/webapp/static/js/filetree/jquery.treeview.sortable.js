(function(a){if(window.Node&&Node.prototype&&!Node.prototype.contains){Node.prototype.contains=function(b){return !!(this.compareDocumentPosition(b)&16)}}a.widget("ui.sortableTree",a.extend(a.ui.mouse,{init:function(){var b=this,c=this.options;this.containerCache={};this.element.addClass("ui-sortableTree");this.refresh();if(!(/(relative|absolute|fixed)/).test(this.element.css("position"))){this.element.css("position","relative")}this.offset=this.element.offset();this.mouseInit();if(c.cursorAt&&c.cursorAt.constructor==Array){c.cursorAt={left:c.cursorAt[0],top:c.cursorAt[1]}}},plugins:{},ui:function(b){return{helper:(b||this)["helper"],position:(b||this)["position"].current,absolutePosition:(b||this)["position"].absolute,instance:this,options:this.options,element:this.element,item:(b||this)["currentItem"],sender:b?b.element:null}},propagate:function(d,c,b){a.ui.plugin.call(this,d,[c,this.ui(b)]);this.element.triggerHandler(d=="sort"?d:"sort"+d,[c,this.ui(b)],this.options[d])},serialize:function(d){var b=a(this.options.items,this.element).not(".ui-sortableTree-helper");var c=[];d=d||{};b.each(function(){var e=(a(this).attr(d.attribute||"id")||"").match(d.expression||(/(.+)[-=_](.+)/));if(e){c.push((d.key||e[1])+"[]="+(d.key?e[1]:e[2]))}});return c.join("&")},toArray:function(b){var c=a(this.options.items,this.element).not(".ui-sortableTree-helper");var d=[];c.each(function(){d.push(a(this).attr(b||"id"))});return d},enable:function(){this.element.removeClass("ui-sortableTree-disabled");this.options.disabled=false},disable:function(){this.element.addClass("ui-sortableTree-disabled");this.options.disabled=true},intersectsWith:function(j){var e=this.position.absolute.left-10,d=e+10,i=this.position.absolute.top-10,h=i+10;var f=j.left,c=f+j.width,k=j.top,g=k+j.height;return(f<e+(this.helperProportions.width/2)&&d-(this.helperProportions.width/2)<c&&k<i+(this.helperProportions.height/2)&&h-(this.helperProportions.height/2)<g)},intersectsWithEdge:function(g){var f=this.position.absolute.top-10,e=f+10;var d=g.top,c=d+g.height;if(!this.intersectsWith(g.item.parents(".ui-sortableTree").data("sortableTree").containerCache)){return false}if(!(d<f+(this.helperProportions.height/2)&&e-(this.helperProportions.height/2)<c)){return false}if(e>d&&f<d){return 1}if(f<c&&e>c){return 2}return false},refresh:function(){this.refreshItems();this.refreshPositions()},refreshItems:function(){this.items=[];this.containers=[this];var b=this.items;var d=[a(this.options.items,this.element)];if(this.options.connectWith){for(var e=this.options.connectWith.length-1;e>=0;e--){var g=a(this.options.connectWith[e]);for(var c=g.length-1;c>=0;c--){var f=a.data(g[c],"sortableTree");if(f&&!f.options.disabled){d.push(a(f.options.items,f.element));this.containers.push(f)}}}}for(var e=d.length-1;e>=0;e--){d[e].each(function(){a.data(this,"sortableTree-item",true);b.push({item:a(this),width:0,height:0,left:0,top:0})})}},refreshPositions:function(b){for(var c=this.items.length-1;c>=0;c--){if(!b){this.items[c].height=this.items[c].item.outerHeight()}this.items[c].top=this.items[c].item.offset().top}for(var c=this.containers.length-1;c>=0;c--){var d=this.containers[c].element.offset();this.containers[c].containerCache.left=d.left;this.containers[c].containerCache.top=d.top;this.containers[c].containerCache.width=this.containers[c].element.outerWidth();this.containers[c].containerCache.height=this.containers[c].element.outerHeight()}},destroy:function(){this.element.removeClass("ui-sortableTree ui-sortableTree-disabled").removeData("sortableTree").unbind(".sortableTree");this.mouseDestroy();for(var b=this.items.length-1;b>=0;b--){this.items[b].item.removeData("sortableTree-item")}},contactContainers:function(f){for(var c=this.containers.length-1;c>=0;c--){if(this.intersectsWith(this.containers[c].containerCache)){if(!this.containers[c].containerCache.over){if(this.currentContainer!=this.containers[c]){var k=10000;var h=null;var d=this.position.absolute.top;for(var b=this.items.length-1;b>=0;b--){if(!this.containers[c].element[0].contains(this.items[b].item[0])){continue}var g=this.items[b].top;if(Math.abs(g-d)<k){k=Math.abs(g-d);h=this.items[b]}}h?this.rearrange(f,h):this.rearrange(f,null,this.containers[c].element);this.propagate("change",f);this.containers[c].propagate("change",f,this);this.currentContainer=this.containers[c]}this.containers[c].propagate("over",f,this);this.containers[c].containerCache.over=1}}else{if(this.containers[c].containerCache.over){this.containers[c].propagate("out",f,this);this.containers[c].containerCache.over=0}}}},mouseStart:function(g,f){if(this.options.disabled||this.options.type=="static"){return false}var d=null,b=a(g.target).parents().each(function(){if(a.data(this,"sortableTree-item")){d=a(this);return false}});if(a.data(g.target,"sortableTree-item")){d=a(g.target)}if(!d){return false}if(this.options.handle){var j=false;a(this.options.handle,d).each(function(){if(this==g.target){j=true}});if(!j){return false}}this.currentItem=d;var h=this.options;this.currentContainer=this;this.refresh();this.helper=typeof h.helper=="function"?a(h.helper.apply(this.element[0],[g,this.currentItem])):this.currentItem.clone();if(!this.helper.parents("body").length){this.helper.appendTo("body")}this.helper.css({position:"absolute",clear:"both"}).addClass("ui-sortableTree-helper");a.extend(this,{offsetParent:this.helper.offsetParent(),offsets:{absolute:this.currentItem.offset()}});a.extend(this,{position:{current:{left:g.pageX,top:g.pageY},absolute:{left:g.pageX,top:g.pageY},dom:this.currentItem.prev()[0]},clickOffset:{left:-5,top:-5}});this.propagate("start",g);this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()};for(var c=this.containers.length-1;c>=0;c--){this.containers[c].propagate("activate",g,this)}if(a.ui.ddmanager){a.ui.ddmanager.current=this}if(a.ui.ddmanager&&!h.dropBehaviour){a.ui.ddmanager.prepareOffsets(this,g)}this.dragging=true;return true},mouseStop:function(c){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.propagate("stop",c);var d=(a.ui.ddmanager&&!this.options.dropBehaviour)?a.ui.ddmanager.drop(this,c):false;if(!d&&this.newPositionAt){this.newPositionAt[this.direction=="down"?"before":"after"](this.currentItem)}if(this.position.dom!=this.currentItem.prev()[0]){this.propagate("update",c)}if(!this.element[0].contains(this.currentItem[0])){this.propagate("remove",c);for(var b=this.containers.length-1;b>=0;b--){if(this.containers[b].element[0].contains(this.currentItem[0])){this.containers[b].propagate("update",c,this);this.containers[b].propagate("receive",c,this)}}}for(var b=this.containers.length-1;b>=0;b--){this.containers[b].propagate("deactivate",c,this);if(this.containers[b].containerCache.over){this.containers[b].propagate("out",c,this);this.containers[b].containerCache.over=0}}this.dragging=false;if(this.cancelHelperRemoval){return false}this.helper.remove();return false},mouseDrag:function(d){this.position.current={top:d.pageY+5,left:d.pageX+5};this.position.absolute={left:d.pageX+5,top:d.pageY+5};if(a.ui.ddmanager){a.ui.ddmanager.drag(this,d)}var b=false;a.each(a.ui.ddmanager.droppables,function(){if(this.isover){b=true}});if(b){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}}else{for(var c=this.items.length-1;c>=0;c--){if(this.currentItem[0].contains(this.items[c].item[0])){continue}var f=this.intersectsWithEdge(this.items[c]);if(!f){continue}this.direction=f==1?"down":"up";this.rearrange(d,this.items[c]);this.propagate("change",d);break}}this.contactContainers(d);this.propagate("sort",d);this.helper.css({left:this.position.current.left+"px",top:this.position.current.top+"px"});return false},rearrange:function(d,c,b){if(c){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.newPositionAt=c.item;this.options.sortIndication[this.direction].call(this.currentItem,this.newPositionAt)}else{}}}));a.extend(a.ui.sortableTree,{defaults:{items:"> *",zIndex:1000,distance:1},getter:"serialize toArray"})})(jQuery);