(function(b){if(window.Node&&Node.prototype&&!Node.prototype.contains){Node.prototype.contains=function(a){return !!(this.compareDocumentPosition(a)&16)}}b.widget("ui.sortableTree",b.extend(b.ui.mouse,{init:function(){var a=this,d=this.options;this.containerCache={};this.element.addClass("ui-sortableTree");this.refresh();if(!(/(relative|absolute|fixed)/).test(this.element.css("position"))){this.element.css("position","relative")}this.offset=this.element.offset();this.mouseInit();if(d.cursorAt&&d.cursorAt.constructor==Array){d.cursorAt={left:d.cursorAt[0],top:d.cursorAt[1]}}},plugins:{},ui:function(a){return{helper:(a||this)["helper"],position:(a||this)["position"].current,absolutePosition:(a||this)["position"].absolute,instance:this,options:this.options,element:this.element,item:(a||this)["currentItem"],sender:a?a.element:null}},propagate:function(e,f,a){b.ui.plugin.call(this,e,[f,this.ui(a)]);this.element.triggerHandler(e=="sort"?e:"sort"+e,[f,this.ui(a)],this.options[e])},serialize:function(e){var a=b(this.options.items,this.element).not(".ui-sortableTree-helper");var f=[];e=e||{};a.each(function(){var c=(b(this).attr(e.attribute||"id")||"").match(e.expression||(/(.+)[-=_](.+)/));if(c){f.push((e.key||c[1])+"[]="+(e.key?c[1]:c[2]))}});return f.join("&")},toArray:function(a){var f=b(this.options.items,this.element).not(".ui-sortableTree-helper");var e=[];f.each(function(){e.push(b(this).attr(a||"id"))});return e},enable:function(){this.element.removeClass("ui-sortableTree-disabled");this.options.disabled=false},disable:function(){this.element.addClass("ui-sortableTree-disabled");this.options.disabled=true},intersectsWith:function(l){var q=this.position.absolute.left-10,r=q+10,m=this.position.absolute.top-10,n=m+10;var p=l.left,a=p+l.width,k=l.top,o=k+l.height;return(p<q+(this.helperProportions.width/2)&&r-(this.helperProportions.width/2)<a&&k<m+(this.helperProportions.height/2)&&n-(this.helperProportions.height/2)<o)},intersectsWithEdge:function(a){var g=this.position.absolute.top-10,h=g+10;var i=a.top,j=i+a.height;if(!this.intersectsWith(a.item.parents(".ui-sortableTree").data("sortableTree").containerCache)){return false}if(!(i<g+(this.helperProportions.height/2)&&h-(this.helperProportions.height/2)<j)){return false}if(h>i&&g<i){return 1}if(g<j&&h>j){return 2}return false},refresh:function(){this.refreshItems();this.refreshPositions()},refreshItems:function(){this.items=[];this.containers=[this];var l=this.items;var k=[b(this.options.items,this.element)];if(this.options.connectWith){for(var j=this.options.connectWith.length-1;j>=0;j--){var h=b(this.options.connectWith[j]);for(var a=h.length-1;a>=0;a--){var i=b.data(h[a],"sortableTree");if(i&&!i.options.disabled){k.push(b(i.options.items,i.element));this.containers.push(i)}}}}for(var j=k.length-1;j>=0;j--){k[j].each(function(){b.data(this,"sortableTree-item",true);l.push({item:b(this),width:0,height:0,left:0,top:0})})}},refreshPositions:function(a){for(var f=this.items.length-1;f>=0;f--){if(!a){this.items[f].height=this.items[f].item.outerHeight()}this.items[f].top=this.items[f].item.offset().top}for(var f=this.containers.length-1;f>=0;f--){var e=this.containers[f].element.offset();this.containers[f].containerCache.left=e.left;this.containers[f].containerCache.top=e.top;this.containers[f].containerCache.width=this.containers[f].element.outerWidth();this.containers[f].containerCache.height=this.containers[f].element.outerHeight()}},destroy:function(){this.element.removeClass("ui-sortableTree ui-sortableTree-disabled").removeData("sortableTree").unbind(".sortableTree");this.mouseDestroy();for(var a=this.items.length-1;a>=0;a--){this.items[a].item.removeData("sortableTree-item")}},contactContainers:function(m){for(var e=this.containers.length-1;e>=0;e--){if(this.intersectsWith(this.containers[e].containerCache)){if(!this.containers[e].containerCache.over){if(this.currentContainer!=this.containers[e]){var i=10000;var j=null;var a=this.position.absolute.top;for(var n=this.items.length-1;n>=0;n--){if(!this.containers[e].element[0].contains(this.items[n].item[0])){continue}var l=this.items[n].top;if(Math.abs(l-a)<i){i=Math.abs(l-a);j=this.items[n]}}j?this.rearrange(m,j):this.rearrange(m,null,this.containers[e].element);this.propagate("change",m);this.containers[e].propagate("change",m,this);this.currentContainer=this.containers[e]}this.containers[e].propagate("over",m,this);this.containers[e].containerCache.over=1}}else{if(this.containers[e].containerCache.over){this.containers[e].propagate("out",m,this);this.containers[e].containerCache.over=0}}}},mouseStart:function(l,m){if(this.options.disabled||this.options.type=="static"){return false}var a=null,n=b(l.target).parents().each(function(){if(b.data(this,"sortableTree-item")){a=b(this);return false}});if(b.data(l.target,"sortableTree-item")){a=b(l.target)}if(!a){return false}if(this.options.handle){var i=false;b(this.options.handle,a).each(function(){if(this==l.target){i=true}});if(!i){return false}}this.currentItem=a;var k=this.options;this.currentContainer=this;this.refresh();this.helper=typeof k.helper=="function"?b(k.helper.apply(this.element[0],[l,this.currentItem])):this.currentItem.clone();if(!this.helper.parents("body").length){this.helper.appendTo("body")}this.helper.css({position:"absolute",clear:"both"}).addClass("ui-sortableTree-helper");b.extend(this,{offsetParent:this.helper.offsetParent(),offsets:{absolute:this.currentItem.offset()}});b.extend(this,{position:{current:{left:l.pageX,top:l.pageY},absolute:{left:l.pageX,top:l.pageY},dom:this.currentItem.prev()[0]},clickOffset:{left:-5,top:-5}});this.propagate("start",l);this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()};for(var e=this.containers.length-1;e>=0;e--){this.containers[e].propagate("activate",l,this)}if(b.ui.ddmanager){b.ui.ddmanager.current=this}if(b.ui.ddmanager&&!k.dropBehaviour){b.ui.ddmanager.prepareOffsets(this,l)}this.dragging=true;return true},mouseStop:function(f){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.propagate("stop",f);var e=(b.ui.ddmanager&&!this.options.dropBehaviour)?b.ui.ddmanager.drop(this,f):false;if(!e&&this.newPositionAt){this.newPositionAt[this.direction=="down"?"before":"after"](this.currentItem)}if(this.position.dom!=this.currentItem.prev()[0]){this.propagate("update",f)}if(!this.element[0].contains(this.currentItem[0])){this.propagate("remove",f);for(var a=this.containers.length-1;a>=0;a--){if(this.containers[a].element[0].contains(this.currentItem[0])){this.containers[a].propagate("update",f,this);this.containers[a].propagate("receive",f,this)}}}for(var a=this.containers.length-1;a>=0;a--){this.containers[a].propagate("deactivate",f,this);if(this.containers[a].containerCache.over){this.containers[a].propagate("out",f,this);this.containers[a].containerCache.over=0}}this.dragging=false;if(this.cancelHelperRemoval){return false}this.helper.remove();return false},mouseDrag:function(g){this.position.current={top:g.pageY+5,left:g.pageX+5};this.position.absolute={left:g.pageX+5,top:g.pageY+5};if(b.ui.ddmanager){b.ui.ddmanager.drag(this,g)}var a=false;b.each(b.ui.ddmanager.droppables,function(){if(this.isover){a=true}});if(a){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}}else{for(var h=this.items.length-1;h>=0;h--){if(this.currentItem[0].contains(this.items[h].item[0])){continue}var e=this.intersectsWithEdge(this.items[h]);if(!e){continue}this.direction=e==1?"down":"up";this.rearrange(g,this.items[h]);this.propagate("change",g);break}}this.contactContainers(g);this.propagate("sort",g);this.helper.css({left:this.position.current.left+"px",top:this.position.current.top+"px"});return false},rearrange:function(e,f,a){if(f){if(this.newPositionAt){this.options.sortIndication.remove.call(this.currentItem,this.newPositionAt)}this.newPositionAt=f.item;this.options.sortIndication[this.direction].call(this.currentItem,this.newPositionAt)}else{}}}));b.extend(b.ui.sortableTree,{defaults:{items:"> *",zIndex:1000,distance:1},getter:"serialize toArray"})})(jQuery);